<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE mapper PUBLIC
"-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="patient">

	<resultMap id="resultPatient" type="Patient">
		<result property="p_phone" column="p_phone" typeHandler="strArrPhoneTypeHandler"/>		
	</resultMap>
	
	<select id="selectPatientList" parameterType="string" resultMap="resultPatient">
		SELECT * FROM PATIENT WHERE P_NAME = #{p_name}
	</select>
		
	<select id="selectUpdatePatient" parameterType="_int" resultMap="resultPatient">
		SELECT * FROM PATIENT WHERE P_NO = #{p_no}
	</select>
	
	<select id="selectWardList" resultType="Ward">
		SELECT W.*, COUNT(P.WARD_CODE) CUR_CAPACITY
			FROM PATIENT P
			RIGHT JOIN WARD W ON(W.WARD_CODE = P.WARD_CODE)
			GROUP BY P.WARD_CODE, W.WARD_CODE, W.CAPACITY
			ORDER BY W.WARD_CODE
	</select>
	
	<select id="selectWard" resultType="Ward">
		SELECT W.*, W.CAPACITY-COUNT(P.WARD_CODE) AVAILABLE_CAPACITY
			FROM PATIENT P
			RIGHT JOIN WARD W ON(W.WARD_CODE = P.WARD_CODE)
			GROUP BY P.WARD_CODE, W.WARD_CODE, W.CAPACITY
			ORDER BY W.WARD_CODE
	</select>
		
	<select id="selectWardPatient" parameterType="_int" resultMap="resultPatient">
		SELECT * FROM PATIENT WHERE WARD_CODE = #{ward_code}
	</select>
	
	<insert id="insertPatient" parameterType="Patient">
		INSERT INTO PATIENT VALUES (
			SEQ_P_NO.NEXTVAL, #{p_name}, #{p_age}, #{p_gender}, 
			#{p_address}, #{p_phone, typeHandler=strArrPhoneTypeHandler}, NULL,
			NULL, NULL, #{p_rrn}, SYSDATE, SYSDATE) 
	</insert>
	
	<update id="outPatientReceipt" parameterType="_int">
		UPDATE PATIENT SET P_LASTDATE = SYSDATE WHERE P_NO=#{p_no} 
	</update>
	
	<update id="updatePatient" parameterType="Patient">
		UPDATE PATIENT SET 
			P_NAME = #{p_name}, P_AGE = #{p_age}, P_GENDER = #{p_gender}, 
			P_ADDRESS = #{p_address}, P_PHONE = #{p_phone, typeHandler=strArrPhoneTypeHandler}, 
			P_RRN = #{p_rrn} WHERE P_NO = #{p_no}
		
	</update>
	
	<update id="inPatientReceipt" parameterType="Patient">
		UPDATE PATIENT SET
			P_ADMISSION_DATE = #{p_admission_date}, WARD_CODE = #{ward_code} 
		WHERE P_NO = #{p_no}
	</update>
	
	
</mapper>
